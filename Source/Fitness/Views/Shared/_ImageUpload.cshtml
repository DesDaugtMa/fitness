@*
    Parameter:
    ViewData["InputName"]    - Der Name für den Controller (Standard: ImageFile)
    ViewData["UploadHeight"] - Höhe (z.B. 250px)
    ViewData["UploadWidth"]  - Breite (z.B. 100% oder 300px)
    ViewData["IsOptional"]   - Zeigt "(optional)" an (bool, Standard: false)
*@

@{
    var inputName = ViewData["InputName"] ?? "ImageFile";
    var height = ViewData["UploadHeight"] ?? "250px";
    var width = ViewData["UploadWidth"] ?? "100%";
    var isOptional = ViewData["IsOptional"] != null && (bool)ViewData["IsOptional"];

    // Eindeutige ID für CSS und JS Präfixe
    var uid = "upl" + Guid.NewGuid().ToString("N").Substring(0, 8);
}

<style>
    .@(uid)-wrapper {
        width: @width;
        max-width: 100%;
        margin-bottom: 1rem;
    }

    .@(uid)-drop-zone {
        width: 100%;
        height: @height;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

        .@(uid)-drop-zone:hover, .@(uid)-drop-zone.drag-over {
            border-color: #4a90e2;
            background: #f0f7ff;
        }

    .@(uid)-info {
        text-align: center;
        color: #64748b;
        padding: 15px;
    }

    .@(uid)-drag-text {
        display: none; /* Mobile versteckt */
    }

    @@media (min-width: 768px) {
        .@(uid)-drag-text {
            display: inline; /* PC sichtbar */
        }
    }

    .@(uid)-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
    }

    .@(uid)-reset {
        margin-top: 10px;
        display: none;
    }

    .@(uid)-optional-hint {
        display: block;
        margin-top: 4px;
        color: #94a3b8;
    }
</style>

<div class="@(uid)-wrapper">
    <div class="@(uid)-drop-zone" id="dz-@uid">
        <div class="@(uid)-info" id="info-@uid">
            <i class="bi bi-card-image" style="font-size: 2rem; display: block;"></i>
            <strong>Bild auswählen</strong>
            <span class="@(uid)-drag-text"><br>oder hierher ziehen</span>

            @if (isOptional)
            {
                <small class="@(uid)-optional-hint">(optional)</small>
            }
        </div>
        <img class="@(uid)-preview" id="prev-@uid">
    </div>

    <input type="file" name="@inputName" id="file-@uid" accept="image/*" style="display:none;">

    <button type="button" class="btn btn-sm btn-outline-danger @(uid)-reset" id="reset-@uid">
        Bild entfernen
    </button>
</div>

<script>
    (function() {
        const u = "@uid";
        const dz = document.getElementById('dz-' + u);
        const fi = document.getElementById('file-' + u);
        const pr = document.getElementById('prev-' + u);
        const info = document.getElementById('info-' + u);
        const rb = document.getElementById('reset-' + u);

        if(!dz) return;

        dz.addEventListener('click', () => fi.click());

        ['dragenter', 'dragover'].forEach(e => {
            dz.addEventListener(e, (ev) => {
                ev.preventDefault();
                dz.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(e => {
            dz.addEventListener(e, (ev) => {
                ev.preventDefault();
                dz.classList.remove('drag-over');
            });
        });

        dz.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
                fi.files = files;
                handleFile(files[0]);
            }
        });

        fi.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                pr.src = e.target.result;
                pr.style.display = 'block';
                info.style.display = 'none';
                rb.style.display = 'inline-block';
                dz.style.borderStyle = 'solid';
            };
            reader.readAsDataURL(file);
        }

        rb.addEventListener('click', (e) => {
            e.stopPropagation();
            fi.value = '';
            pr.src = '';
            pr.style.display = 'none';
            info.style.display = 'block';
            rb.style.display = 'none';
            dz.style.borderStyle = 'dashed';
        });
    })();
</script>